<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain Explorer Simulator | DeFi University</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        const firebaseConfig = {
            apiKey: "AIzaSyDuGdDF6jYPcZbQTpbGZPwnl3Qynr-LMWc",
            authDomain: "defi-university-prod.firebaseapp.com",
            projectId: "defi-university-prod",
            storageBucket: "defi-university-prod.firebasestorage.app",
            messagingSenderId: "309871336262",
            appId: "1:309871336262:web:d2dc4be5729ac1d5a6a347"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        let userToken = null;
        let tracked = false;

        onAuthStateChanged(auth, async (user) => {
            const loginPrompt = document.getElementById('login-prompt');
            const toolContainer = document.getElementById('tool-container');
            const loadingState = document.getElementById('loading-state');
            if (user) {
                userToken = await user.getIdToken();
                if (loginPrompt) loginPrompt.classList.add('hidden');
                if (loadingState) loadingState.classList.add('hidden');
                if (toolContainer) toolContainer.classList.remove('hidden');
                initBlockchain();
            } else {
                if (loadingState) loadingState.classList.add('hidden');
                if (loginPrompt) loginPrompt.classList.remove('hidden');
                if (toolContainer) toolContainer.classList.add('hidden');
                const currentUrl = encodeURIComponent(window.location.href);
                const loginLink = document.querySelector('#login-prompt a');
                if (loginLink) loginLink.href = `/login.html?redirect=${currentUrl}`;
            }
        });

        window.trackInteraction = async function() {
            if (!tracked && userToken) {
                tracked = true;
                try {
                    const response = await fetch('https://api.defiuniversity.xyz/api/progress/interaction', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                        body: JSON.stringify({ courseId: 'crypto-fundamentals', interactionId: 'blockchain-explorer', type: 'explorer' })
                    });
                    if (response.ok) {
                        const badge = document.getElementById('points-badge');
                        if (badge) { badge.classList.remove('hidden'); setTimeout(() => badge.classList.add('hidden'), 2500); }
                    }
                } catch (e) { console.error('Tracking error:', e); tracked = false; }
            }
        };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; }
        h1, h2, h3, h4, .brand-font { font-family: 'Space Grotesk', sans-serif; }
        .block-card { transition: all 0.3s ease; }
        .block-card:hover { transform: translateY(-2px); }
        .chain-link { background: linear-gradient(90deg, #3b82f6 0%, #3b82f6 100%); height: 3px; }
    </style>
</head>
<body class="bg-white text-neutral-900 min-h-screen p-4 md:p-8">
    <div id="loading-state" class="flex items-center justify-center min-h-[400px]">
        <div class="text-center">
            <div class="w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-neutral-500">Loading tool...</p>
        </div>
    </div>

    <div id="login-prompt" class="hidden max-w-md mx-auto text-center py-12">
        <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="text-blue-600"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
        </div>
        <h2 class="text-xl font-semibold text-neutral-900 mb-2 brand-font">Sign in Required</h2>
        <p class="text-neutral-500 mb-6">Please sign in to use this interactive tool and earn points.</p>
        <a href="/login.html" class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors shadow-md shadow-blue-600/20">Sign In</a>
    </div>

    <div id="tool-container" class="hidden max-w-5xl mx-auto">
        <div id="points-badge" class="hidden fixed top-4 right-4 bg-green-50 border border-green-200 text-green-600 px-4 py-2 rounded-full text-sm font-semibold z-50">+25 points earned!</div>
        
        <div class="text-center mb-8">
            <h1 class="text-2xl md:text-3xl font-semibold text-neutral-900 brand-font mb-2">Blockchain Explorer Simulator</h1>
            <p class="text-neutral-500">Visualize how blocks connect and transactions are recorded</p>
        </div>

        <div class="bg-white border border-neutral-200 rounded-xl p-6 shadow-sm space-y-6">
            <div class="flex flex-wrap gap-4 justify-center">
                <button onclick="addBlock()" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors shadow-md shadow-blue-600/20">⛏️ Mine New Block</button>
                <button onclick="addTransaction()" class="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors">➕ Add Transaction</button>
            </div>

            <div id="pending-tx" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-sm font-medium text-yellow-700 mb-2">Pending Transactions (Mempool)</p>
                <div id="pending-list" class="text-sm text-yellow-600 space-y-1"></div>
            </div>

            <div id="blockchain" class="flex overflow-x-auto pb-4 gap-4 items-start">
                <!-- Blocks will be added here -->
            </div>

            <div id="block-details" class="hidden bg-neutral-50 border border-neutral-200 rounded-lg p-4">
                <h3 class="font-semibold text-neutral-900 mb-2 brand-font">Block Details</h3>
                <div id="details-content" class="text-sm space-y-1"></div>
            </div>

            <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                <p class="text-sm font-medium text-amber-700 mb-1">How It Works</p>
                <p id="insight" class="text-sm text-amber-600">Each block contains transactions and links to the previous block via a hash. Click "Mine New Block" to add pending transactions to the chain. Notice how each block's "Previous Hash" matches the previous block's "Hash" - that's what makes it a chain!</p>
            </div>
        </div>
    </div>

    <script>
        let blocks = [];
        let pendingTx = [];
        let txCounter = 0;

        function generateHash() {
            const chars = '0123456789abcdef';
            let hash = '0x';
            for (let i = 0; i < 16; i++) {
                hash += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return hash;
        }

        function initBlockchain() {
            // Genesis block
            const genesis = {
                number: 0,
                hash: generateHash(),
                prevHash: '0x0000000000000000',
                timestamp: new Date().toISOString(),
                transactions: [{ from: 'Genesis', to: 'Network', amount: '50 COIN', id: 0 }]
            };
            blocks.push(genesis);
            renderBlockchain();
        }

        function addTransaction() {
            txCounter++;
            const wallets = ['Alice', 'Bob', 'Carol', 'Dave', 'Eve'];
            const from = wallets[Math.floor(Math.random() * wallets.length)];
            let to = wallets[Math.floor(Math.random() * wallets.length)];
            while (to === from) to = wallets[Math.floor(Math.random() * wallets.length)];
            const amount = (Math.random() * 10 + 0.1).toFixed(2);
            
            pendingTx.push({ from, to, amount: amount + ' COIN', id: txCounter });
            renderPending();
            window.trackInteraction();
        }

        function addBlock() {
            if (pendingTx.length === 0) {
                alert('No pending transactions! Add some transactions first.');
                return;
            }

            const prevBlock = blocks[blocks.length - 1];
            const newBlock = {
                number: blocks.length,
                hash: generateHash(),
                prevHash: prevBlock.hash,
                timestamp: new Date().toISOString(),
                transactions: [...pendingTx]
            };
            blocks.push(newBlock);
            pendingTx = [];
            renderBlockchain();
            renderPending();
            window.trackInteraction();
        }

        function renderPending() {
            const container = document.getElementById('pending-tx');
            const list = document.getElementById('pending-list');
            
            if (pendingTx.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            list.innerHTML = pendingTx.map(tx => 
                `<div class="bg-yellow-100 rounded px-2 py-1">TX#${tx.id}: ${tx.from} → ${tx.to}: ${tx.amount}</div>`
            ).join('');
        }

        function renderBlockchain() {
            const container = document.getElementById('blockchain');
            container.innerHTML = blocks.map((block, index) => `
                <div class="flex items-center">
                    ${index > 0 ? '<div class="chain-link w-8 flex-shrink-0"></div>' : ''}
                    <div class="block-card bg-white border-2 border-blue-200 rounded-xl p-4 min-w-[200px] cursor-pointer hover:border-blue-400" onclick="showBlockDetails(${index})">
                        <div class="text-center mb-3">
                            <span class="inline-block px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">
                                ${block.number === 0 ? 'Genesis' : 'Block #' + block.number}
                            </span>
                        </div>
                        <div class="space-y-2 text-xs">
                            <div>
                                <span class="text-neutral-500">Hash:</span>
                                <span class="font-mono text-blue-600 block truncate">${block.hash}</span>
                            </div>
                            <div>
                                <span class="text-neutral-500">Prev:</span>
                                <span class="font-mono text-purple-600 block truncate">${block.prevHash}</span>
                            </div>
                            <div class="pt-2 border-t border-neutral-100">
                                <span class="text-neutral-700 font-medium">${block.transactions.length} transaction(s)</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showBlockDetails(index) {
            const block = blocks[index];
            const details = document.getElementById('block-details');
            const content = document.getElementById('details-content');

            content.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div><span class="text-neutral-500">Block Number:</span> <span class="font-medium">${block.number}</span></div>
                    <div><span class="text-neutral-500">Timestamp:</span> <span class="font-medium">${new Date(block.timestamp).toLocaleString()}</span></div>
                </div>
                <div class="mb-2"><span class="text-neutral-500">Hash:</span> <span class="font-mono text-blue-600">${block.hash}</span></div>
                <div class="mb-4"><span class="text-neutral-500">Previous Hash:</span> <span class="font-mono text-purple-600">${block.prevHash}</span></div>
                <div class="border-t border-neutral-200 pt-3">
                    <p class="font-medium text-neutral-700 mb-2">Transactions:</p>
                    ${block.transactions.map(tx => `
                        <div class="bg-neutral-100 rounded px-3 py-2 mb-1 text-xs">
                            TX#${tx.id}: <span class="text-blue-600">${tx.from}</span> → <span class="text-green-600">${tx.to}</span>: <span class="font-medium">${tx.amount}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            details.classList.remove('hidden');
        }
    </script>
</body>
</html>
